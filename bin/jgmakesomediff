#!/bin/bash

OPTIND=1
outDir="$HOME/Desktop"
modDir="mod"
origDir="orig"

while getopts "h?d:o:m:" opt; do
    case "$opt" in
        h|\?)
            echo -e "\nMake some diff"
            echo -e "Usage:"
            echo -e "jgmakesomediff [-d <output-dir>] [-o <orig-dir>] [-m mod-dir] [<orig-revision>]"
            echo -e "               [<mod-revision>]\n"
            echo -e "Export two directories to <output-dir> for compare. One is named <mod-dir>, containing modified files in revision <mod-revision> compared to revision <orig-revision>, the other named <orig-dir> containing those files in <orig-revision>.\n"
            echo -e "Default:"
            echo -e "<output-dir>       \$HOME/Desktop/"
            echo -e "<orig-dir>         orig"
            echo -e "<mod-dir>          mod"
            echo -e "<orig-revision>    @"
            echo -e "<mod-revision>     (working tree)"
            exit 0
            ;;
        d)  outDir=$OPTARG
            ;;
        o)  origDir=$OPTARG
            ;;
        m)  modDir=$OPTARG
            ;;
    esac
done

shift $((OPTIND-1))

[[ "${1:-}" = "--" ]] && shift

revOrig="@"
revMod=""
[[ "${1:-}" ]] && revOrig=$1
[[ "${2:-}" ]] && revMod=$2

mkdir -p $outDir/$origDir/ $outDir/$modDir/
if [[ $(ls -A $outDir/$origDir/) || $(ls -A $outDir/$modDir/) ]]; then
    echo "Error: either $outDir/$origDir or $outDir/$modDir is not empty."
    exit 1
fi

diffOrig=$(git diff -M100% --diff-filter=a --name-only $revOrig $revMod 2>/dev/null)
for origFile in $diffOrig
do
    if [[ "$origFile" == *"/"* ]]; then
        origFileDir=${origFile%/*}
        mkdir -p $outDir/$origDir/$origFileDir
    fi
    git show $revOrig:$origFile > $outDir/$origDir/$origFile
done

diffMod=$(git diff -M100% --diff-filter=d --name-only $revOrig $revMod 2>/dev/null)
[[ "$diffMod" ]] || exit 0
if [[ "$revMod" ]]; then
    for modFile in $diffMod
    do
        if [[ "$modFile" == *"/"* ]]; then
            modFileDir=${modFile%/*}
            mkdir -p $outDir/$modDir/$modFileDir
        fi
        git show $revMod:$modFile > $outDir/$modDir/$modFile
    done
else
    cp --parents $diffMod $outDir/$modDir/
fi
