#!/bin/bash
fn=~/NtmOutput.txt
echo 'RelatedFiles:' > ${fn}
gpro=$(git status --porcelain)
if [ -z "${gpro}" ]; then
    commitnumber=$(git log -1 --pretty=format:"%H")
    if [ -n "${commitnumber}" ]; then
        echo -e "> No local changes, trying to compare with 2nd last commit."
        git reset head~1 > /dev/null
        gpro=$(git status --porcelain)
        git reset "${commitnumber}"
    fi
fi
if [ -n "${gpro}" ]; then
    staged=$(echo "${gpro}" | egrep '^M|^A|^R|^D')
    if [ -n "${staged}" ]; then
        echo -e "> We have something staged, so will ignore the unstaged changes."
        modtag="^M. "
        addtag="^A. "
        addsub="^A. "
        rentag="^R. "
        deltag="^D. "
    else
        modtag="^ M "
        addtag="^\\?\\? "
        addsub="^?\\{2\\} "
        deltag="^ D "
    fi
    gmod=$(echo "${gpro}" | egrep "${modtag}" | egrep -v 'History\.txt')
    if [ -n "${gmod}" ]; then
        echo 'Modified:' >> ${fn}
        echo "${gmod}" >> ${fn}
        vim -n --noplugin -c "%s/${modtag}//ge|let b:currline=search('^Modified:\$')|/^Modified:\$/+,\$s/^/\\=line('.')-b:currline.'. '/ge|wq" ${fn}
    fi
    gadd=$(echo "${gpro}" | egrep "${addtag}")
    if [ -n "${gadd}" ]; then
        echo 'Added:' >> ${fn}
        echo "${gadd}" >> ${fn}
        vim -n --noplugin -c "%s/${addsub}//ge|let b:currline=search('^Added:\$')|/^Added:\$/+,\$s/^/\\=line('.')-b:currline.'. '/ge|wq" ${fn}
    fi
    if [ "${rentag:-unstage}" != "unstage" ]; then
        gren=$(echo "${gpro}" | egrep "${rentag}")
        if [ -n "${gren}" ]; then
            echo 'Renamed:' >> ${fn}
            echo "${gren}" >> ${fn}
            vim -n --noplugin -c "%s/${rentag}//ge|let b:currline=search('^Renamed:\$')|/^Renamed:\$/+,\$s/^/\\=line('.')-b:currline.'. '/ge|wq" ${fn}
        fi
    fi
    gsub=$(echo "${gpro}" | egrep "${deltag}")
    if [ -n "${gsub}" ]; then
        echo 'Removed:' >> ${fn}
        echo "${gsub}" >> ${fn}
        vim -n --noplugin -c "%s/${deltag}//ge|let b:currline=search('^Removed:\$')|/^Removed:\$/+,\$s/^/\\=line('.')-b:currline.'. '/ge|wq" ${fn}
    fi
fi
vim -n --noplugin -c '%s,/,\\,ge|%y+|wq' ${fn}
echo -e "> Output has been copied to clipboard."
