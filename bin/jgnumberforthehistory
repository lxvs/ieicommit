#!/bin/bash
# https://github.com/lxvs/jg

declare -r title='RelatedFiles:'
declare -r mod_title='Modified:'
declare -r add_title='Added:'
declare -r del_title='Deleted:'
declare -r ren_title='Renamed:'
declare -r cpy_title='Copied:'

# Insert number column before file list.
# $1: porcelain tag
# $2: title
InsNum(){
    vim - --not-a-term -es "+%s/$1//ge" \
        "+let b:currline=search('^$2\$')" \
        "+/^$2\$/+,\$s/^/\\=line('.')-b:currline.'. '/ge" \
        "+%p|q!"
}

if [ -z "$(git diff --cached --name-only 2>/dev/null)" ]; then
    >&2 echo "ERROR: No staged changes."
    exit 1
fi

declare -r staged=$(git status --porcelain | egrep '^[MADRC]')
declare -r modtag='^M. '
declare -r addtag='^A. '
declare -r deltag='^D. '
declare -r rentag='^R. '
declare -r cpytag='^C. '
LF='
'

moded=$(echo "$staged" | egrep "$modtag")
[ -n "$moded" ] && moded=$(echo "$LF$mod_title$LF$moded" | InsNum "$modtag" "$mod_title")

added=$(echo "$staged" | egrep "$addtag")
[ -n "$added" ] && added=$(echo "$LF$add_title$LF$added" | InsNum "$addtag" "$add_title")

deled=$(echo "$staged" | egrep "$deltag")
[ -n "$deled" ] && deled=$(echo "$LF$del_title$LF$deled" | InsNum "$deltag" "$del_title")

rened=$(echo "$staged" | egrep "$rentag")
[ -n "$rened" ] && rened=$(echo "$LF$ren_title$LF$rened" | InsNum "$rentag" "$ren_title")

cpyed=$(echo "$staged" | egrep "$cpytag")
[ -n "$cpyed" ] && cpyed=$(echo "$LF$cpy_title$LF$cpyed" | InsNum "$cpytag" "$cpy_title")

echo "$title$moded$added$deled$rened$cpyed" | sed '/^\s*$/d'
